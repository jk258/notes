# 2025 年的现代 Node.js 模式
## 模块系统：ESM 成为新标准
在`package.json`中添加`"type": "module"`,然后如下引入模块：
```js
import { readFile } from 'node:fs/promises';
```
## 支持顶部Await
```js
// app.js - Clean initialization without wrapper functions
import { readFile } from 'node:fs/promises';

const config = JSON.parse(await readFile('config.json', 'utf8'));
const server = createServer(/* ... */);

console.log('App started with config:', config.appName);
```
## 内置web模块
Node现在原生支持`Feth API`，并且可以获得内置的超时和取消支持
```js
async function fetchData(url) {
  try {
    const response = await fetch(url, {
      signal: AbortSignal.timeout(5000) // Built-in timeout support
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    return await response.json();
  } catch (error) {
    if (error.name === 'TimeoutError') {
      throw new Error('Request timed out');
    }
    throw error;
  }
}

```
`AbortController`取消
```js
// Cancel long-running operations cleanly
const controller = new AbortController();

// Set up automatic cancellation
setTimeout(() => controller.abort(), 10000);

try {
  const data = await fetch('https://slow-api.com/data', {
    signal: controller.signal
  });
  console.log('Data received:', data);
} catch (error) {
  if (error.name === 'AbortError') {
    console.log('Request was cancelled - this is expected behavior');
  } else {
    console.error('Unexpected error:', error);
  }
}

```
## 内置测试
过去，测试需要在 Jest、Mocha、Ava 或其他框架之间进行选择。Node.js 现在包括一个功能齐全的测试运行程序，可以满足大多数测试需求，而无需任何外部依赖项。
```js
// test/math.test.js
import { test, describe } from 'node:test';
import assert from 'node:assert';
import { add, multiply } from '../math.js';

describe('Math functions', () => {
  test('adds numbers correctly', () => {
    assert.strictEqual(add(2, 3), 5);
  });

  test('handles async operations', async () => {
    const result = await multiply(2, 3);
    assert.strictEqual(result, 6);
  });

  test('throws on invalid input', () => {
    assert.throws(() => add('a', 'b'), /Invalid input/);
  });
});

```
它与node的开发工作流程无缝集成
```sh
# Run all tests with built-in runner
node --test

# Watch mode for development
node --test --watch

# Coverage reporting (Node.js 20+)
node --test --experimental-test-coverage
```
## 增强开发体验
`--watch`标志消除了对nodemon的需求，`--env-file`消除了对dotenv的需求，如下：
```json
{
  "name": "modern-node-app",
  "type": "module",
  "engines": {
    "node": ">=20.0.0"
  },
  "scripts": {
    "dev": "node --watch --env-file=.env app.js",
    "test": "node --test --watch",
    "start": "node app.js"
  }
}
```
```js
console.log('Connecting to:', process.env.DATABASE_URL);
console.log('API Key loaded:', process.env.API_KEY ? 'Yes' : 'No');
```
## 打包为单个执行文件
现在可以将 Node.js 应用程序捆绑到单个可执行文件中，从而简化部署和分发：
配置文件定义应用程序的捆绑方式：
```json
{
  "main": "app.js",
  "output": "my-app-bundle.blob",
  "disableExperimentalSEAWarning": true
}
```
创建一个自包含的可执行文件
```sh
node --experimental-sea-config sea-config.json
```
在windows下运行
```sh
cp D:\\node.exe my-app.exe #  复制node.exe
npx postject my-app.exe NODE_SEA_BLOB my-app-bundle.blob --sentinel-fuse NODE_SEA_FUSE_fce680ab2cc467b6e072b8b5df1996b2 #二进制签名
```
此时会有一个`my-app.exe`的文件，运行`my-app.exe`执行

## 内部包映射
Node.js 支持导入映射，允许创建干净的内部模块引用：
```json
{
  "imports": {
    "#config": "./src/config/index.js",
    "#utils/*": "./src/utils/*.js",
    "#db": "./src/database/connection.js"
  }
}
```
这为内部模块创建了一个干净、稳定的接口：
```js
import config from '#config';
import { logger, validator } from '#utils/common';
import db from '#db';
```
